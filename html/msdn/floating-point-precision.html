<html><head><title>Точность значений с плавающей точкой</title></head><body>
<p><a href="index.html">Ответы с форумов MSDN</a></p>
<h2>Точность значений с плавающей точкой</h2>
<p>Date: 04.05.2021 18:03:31</p>
<div>
<p><span style="color:#333333; font-family:'Segoe UI','Lucida Grande',Verdana,Arial,Helvetica,sans-serif; font-size:14px">&gt;Интересно что в начале 90х когда я был студенто&#1084; (приче&#1084; не по ко&#1084;пьютерной специальности), об этих (и других - их
 не &#1084;ало) особенностях рассказывали в курсе по вычислительной технике. Очевидно сейчас это тайна. :)</span></p>
<p>Изучается и сейчас, даже в средней школе на инфор&#1084;атике, насколько я по&#1084;ню. Пробле&#1084;а в то&#1084;, что са&#1084;о знание представления с плавающей точкой еще не дает навыка избегать подобных багов, это приходит только с опыто&#1084; реального
 при&#1084;енения их к расчета&#1084;, приче&#1084; баги эти &#1084;огут быть са&#1084;ы&#1084;и разны&#1084;и. Я напри&#1084;ер правило &quot;сравнивать float нужно с точностью до дельты&quot; усвоил сразу, но все равно срезался на то&#1084;, что пытался в
 цикле делать x&#43;=0.01 и ожидал, что результат будет кратен&nbsp;0.01. Я не ду&#1084;аю, что &#1084;ожно требовать знать это от всех пользователей, работающих с ко&#1084;пьютеро&#1084;. Более реальное решение в то&#1084;, чтобы эти пробле&#1084;ы до пользователей
 не доходили. Стандартные float и double быстрые, но неудобные для всего, кро&#1084;е научных расчетов. Использование decimal, где это воз&#1084;ожно, будет хороши&#1084; шаго&#1084; вперед. В Excel, кстати, 1.6 * 10 равно 16 с точностью до 30 знаков после
 запятой, види&#1084;о, у него своя систе&#1084;а вещественных чисел.&nbsp;</p>
<p>&gt;<span style="color:#333333; font-family:'Segoe UI','Lucida Grande',Verdana,Arial,Helvetica,sans-serif; font-size:14px">Я проверяю не на равенство! А пробле&#1084;а в то&#1084;, что проверяе&#1084;ое условие дает True в качестве результата, но при это&#1084;
 выполнятся блок, который должен выполнятся при False!</span></p>
<p>Отладчик использует для вычисления выражений свой интерпретатор IL, который &#1084;ожет и&#1084;еть другие флаги пара&#1084;етров float по сравнению с живы&#1084; процессо&#1084; с CLR.</p>
</div>
<h2>Message 34</h2>
<p>Date: 05.05.2021 16:54:21</p>
<div>
<p><span style="color:#333333; font-family:'Segoe UI','Lucida Grande',Verdana,Arial,Helvetica,sans-serif; font-size:14px">&gt;<em>Скорее всего вы видите округление при выводе.&nbsp;</em></span></p>
<p>Да, похоже, Excel даже если включить показ 30 знаков после запятой, все равно показывает округленное значение. Поэто&#1084;у пробле&#1084;у &#1084;ожно воспроизвести только на более сложных случаях.&nbsp;</p>
<p>&gt;<span style="color:#333333; font-family:'Segoe UI','Lucida Grande',Verdana,Arial,Helvetica,sans-serif; font-size:14px"><em>Decimal и&#1084;еет весь&#1084;а небольшой диапазон и тоже подвержен то&#1084;у же эффекту. Просто пробле&#1084;а проявляется на
 друго&#1084; наборе чисел и привыкшие к десятичной систе&#1084;е люди ее не за&#1084;ечают. :)</em></span></p>
<p>Это так, но&nbsp;<span style="color:#333333; font-family:'Segoe UI','Lucida Grande',Verdana,Arial,Helvetica,sans-serif; font-size:14px">Decimal</span> позволяет избавиться от потери копеек при вычислениях денежных су&#1084;&#1084; в различных финансовых
 приложениях, а большой диапазон та&#1084; часто не требуется. Поэто&#1084;у в бизнес приложениях Decimal &gt;&gt; Double.</p>
<p>&gt;<span style="color:#333333; font-family:'Segoe UI','Lucida Grande',Verdana,Arial,Helvetica,sans-serif; font-size:14px"><em>Другой интересный вопрос - что происходит при сравнении в конкретно&#1084; языке? Целое преобразуется в float/double и пото&#1084;
 сравнивается? Или же float/double преобразуется в целое и сравниваются целые значения? Честно говоря я не знаю как это делает VB. Надо с&#1084;отреть IL который был сгенерирова</em>н.&nbsp;</span></p>
<p>Судя по IL, преобразуется во float и сравнивается:</p>
&nbsp; IL_001e:&nbsp; ldloc.0<br/>
&nbsp; IL_001f:&nbsp; ldc.r4&nbsp; &nbsp; &nbsp;10.<br/>
&nbsp; IL_0024:&nbsp; mul<br/>
&nbsp; IL_0025:&nbsp; ldloc.1<br/>
&nbsp; IL_0026:&nbsp; conv.r4<br/>
&nbsp; IL_0027:&nbsp; cgt
<p>где local 0 -&nbsp;float32 _maxP, local 1 - int32 _selectedP</p>
<p><span style="color:#333333; font-family:'Segoe UI','Lucida Grande',Verdana,Arial,Helvetica,sans-serif; font-size:14px">&gt;<em>&#1084;ой вопрос состоял в то&#1084;, что поче&#1084;у ветвление в If происходит не по результату полученно&#1084;у в теле&nbsp;If,
 а как тут преобразуются числа совершенно неважно! А персонаж, начинает тут нести бред, не относящийся к те&#1084;е заданного вопроса.</em></span></p>
<p>Рассуждения по поводу чисел с плавающей точкой здесь вполне относятся к те&#1084;е вопроса, так как в расс&#1084;атривае&#1084;ой програ&#1084;&#1084;е и&#1084;енно они и происходят. Это публичный фору&#1084;, где каждый &#1084;ожет высказаться, индивидуальной
 по&#1084;ощи никто не обещал. Поче&#1084;у результат If неверен я уже выдвинул одну гипотезу, что дело в разно&#1084; поведении вычислителя выражений в отладчике и реальной програ&#1084;&#1084;ы. Подтвердить на практике не получилось. В один &#1084;о&#1084;ент
 вроде удалось пой&#1084;ать, когда значения были разны&#1084;и, но после перезапуска студии они вновь оказались одинаковы&#1084;и. Воз&#1084;ожно, здесь задействован какой-то глобальный пара&#1084;етр, который влияет на точность вычислений, и зависит от &#1084;ногих
 факторов. Но есть одна тонкость, ведь 1.6*10 = 16, а это степень 2, <strong>соответственно оно должно быть точно представи&#1084;о в IEEE Float!</strong>&nbsp;Поче&#1084;у точность здесь вообще влияет? Слово&#1084;, пробле&#1084;а загадочная, и точного ответа
 пока дать нельзя...</p>
<p></p>
<p></p>
<p></p>
<p><span style="color:#333333; font-family:'Segoe UI','Lucida Grande',Verdana,Arial,Helvetica,sans-serif; font-size:14px"></span></p>
</div>
<h2>Message 33</h2>
<p>Date: 06.05.2021 8:46:01</p>
<div>
<p>Ура, &#1084;не удалось пой&#1084;ать пробле&#1084;у. Пробле&#1084;а воспроизводится только на платфор&#1084;е x64, и в C# и в VB. Собственно вот, значения в отладчике и в реальной програ&#1084;&#1084;е различаются:</p>
<p><img alt="float debugger issue" src="https://social.msdn.microsoft.com/Forums/getfile/1661782"></p>
<p>Как видно, это на 100% пробле&#1084;а точности вычислений с float. При x64 вычисления с float и&#1084;еют такую же точность, как и double, и это сравнение &#1084;ожет быть выполнено без потери точности. Но Visual Studio, в которой выполняется вычислитель
 выражений, всегда является 32-битны&#1084; процессо&#1084;. Поэто&#1084;у в ней данная операция выполняется как есть, и приводит к потере точности. Пробле&#1084;а в тако&#1084; виде проявляется в VS2019, а в VS2012 она проявляется наоборот, значения различаются
 на платфор&#1084;е x86, и в отладчике точность не теряется.&nbsp;&nbsp;</p>
<p></p>
</div>

<hr/><p>Автор: <a href="https://smallsoft2.blogspot.com">VadimTagil</a></p>
<p><a href="https://msdn-whiteknight.github.io/answers/html/">Главная страница</a> - <a href="index.html">Список тем</a> - <a href="https://github.com/MSDN-WhiteKnight/answers">Репозиторий на GitHub</a></p>
</body></html>
